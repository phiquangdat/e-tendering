<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Setup</title>
    <script>
        function generateUserID() {
            return 'USR-' + Date.now();
        }

        function saveUser() {
            const userData = {
                user_id: generateUserID(), // Generate a new unique ID for each submission
                name: document.getElementById("user_name").value,
                address: document.getElementById("user_address").value,
                user_type: document.getElementById("user_type").value,
                password: document.getElementById("user_password").value,
                email: document.getElementById("user_email").value,
                categories: Array.from(document.getElementById("user_categories").selectedOptions).map(option => option.value)
            };

            console.log("Saved JSON:", JSON.stringify(userData));
            alert("User saved! Check console for JSON output.");

            fetch("http://localhost:5500/create_user", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                fetchUsers(); // Refresh the list of users
            })
            .catch(error => console.error("Error:", error));
        }

        function fetchUsers() {
            fetch("http://localhost:5500/users")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(users => {
                const usersTable = document.getElementById("usersTable");
                usersTable.innerHTML = ""; // Clear the table before adding new items
                users.forEach(user => {
                    const row = usersTable.insertRow();
                    row.insertCell(0).textContent = user.user_id;
                    row.insertCell(1).textContent = user.name;
                    row.insertCell(2).textContent = user.address;
                    row.insertCell(3).textContent = user.user_type;
                    row.insertCell(4).textContent = user.email;
                    const deleteCell = row.insertCell(5);
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Delete";
                    deleteButton.onclick = () => deleteUser(user.user_id);
                    deleteCell.appendChild(deleteButton);
                });
            })
            .catch(error => console.error("Error fetching users:", error));
        }

        function fetchUserTypes() {
            fetch("http://localhost:5500/user_types")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(userTypes => {
                    const userTypeDropdown = document.getElementById("user_type");
                    userTypeDropdown.innerHTML = ""; // Clear existing options
                    userTypes.forEach(type => {
                        const option = document.createElement("option");
                        option.value = type;
                        option.textContent = type;
                        userTypeDropdown.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching user types:", error));
        }

        function fetchCategories() {
            fetch("http://localhost:5500/categories")
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(categories => {
                    const categoryDropdown = document.getElementById("user_categories");
                    categoryDropdown.innerHTML = ""; // Clear existing options
                    categories.forEach(category => {
                        const option = document.createElement("option");
                        option.value = category.category_id;
                        option.textContent = category.category_name;
                        categoryDropdown.appendChild(option);
                    });
                })
                .catch(error => console.error("Error fetching categories:", error));
        }

        function deleteUser(userId) {
            fetch(`http://localhost:5500/delete_user/${userId}`, {
                method: "DELETE"
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                fetchUsers(); // Refresh the list of users
            })
            .catch(error => console.error("Error:", error));
        }

        window.onload = function() {
            fetchUsers(); // Fetch and display the list of users on page load
            fetchUserTypes(); // Fetch and display the list of user types on page load
            fetchCategories(); // Fetch and display the list of categories on page load
        };
    </script>
</head>
<body>
    <h2>Enter User Details</h2>
    <form onsubmit="event.preventDefault(); saveUser();">
        <label>User ID: <input type="text" id="user_id" readonly></label><br>
        <label>Name: <input type="text" id="user_name" required></label><br>
        <label>Address: <input type="text" id="user_address" required></label><br>
        <label>User Type: 
            <select id="user_type" required>
                <!-- Options will be populated dynamically -->
            </select>
        </label><br>
        <label>Password: <input type="password" id="user_password" required></label><br>
        <label>Email: <input type="email" id="user_email" required></label><br>
        <label>Categories: 
            <select id="user_categories" multiple>
                <!-- Options will be populated dynamically -->
            </select>
        </label><br>
        <button type="submit">Save User</button>
    </form>

    <h2>List of Users</h2>
    <table border="1">
        <thead>
            <tr>
                <th>User ID</th>
                <th>Name</th>
                <th>Address</th>
                <th>User Type</th>
                <th>Email</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTable"></tbody>
    </table>
</body>
</html>
